<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Attendance PWA</title>
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#667eea">
  <link rel="stylesheet" href="/style.css">
  <style>
    body { font-family: Poppins, sans-serif; background: linear-gradient(135deg,#667eea,#764ba2); color:#fff; margin:0; }
    .app { max-width:720px; margin:0 auto; padding:20px; }
    .card { background: rgba(255,255,255,0.08); padding:16px; border-radius:10px; margin-bottom:12px; }
    .big { font-size:2.4rem; font-weight:700; }
    .muted { opacity:0.9 }
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="card">
      <div id="welcome">Welcome</div>
      <div id="loginArea"><a href="/login.html" style="color:#ffd369; font-weight:600;">Login</a> to continue</div>
    </div>
    <div class="card" id="dashboard" style="display:none;">
      <div class="big" id="attendance">0%</div>
      <div class="muted">Current Attendance</div>
    </div>
    <div class="card" id="assignments" style="display:none;">
      <div class="muted">Upcoming Assignments</div>
      <ul id="assignList"></ul>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Register service worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js').catch(()=>{});
      }

      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (!user || !user.username || !user.token || user.role !== 'parent') return;

      document.getElementById('loginArea').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      document.getElementById('assignments').style.display = 'block';
      document.getElementById('welcome').textContent = `Welcome, ${user.name || user.username}`;

      fetch(`/api/parent/${user.username}/dashboard`, { headers: { 'Authorization': `Bearer ${user.token}` }})
        .then(r => r.json()).then(data => {
          if (data.student) {
            document.getElementById('attendance').textContent = data.student.attendance + '%';
            const list = document.getElementById('assignList');
            list.innerHTML = '';
            (data.assignments || []).slice(0,5).forEach(a => {
              const li = document.createElement('li');
              li.textContent = `${a.subject}: ${a.title} â€” ${a.due_date}`;
              list.appendChild(li);
            });
            // Start SSE for realtime attendance updates
            try {
              const es = new EventSource(`/events/attendance?token=${encodeURIComponent(user.token)}`);
              es.onmessage = (e) => {
                try {
                  const payload = JSON.parse(e.data);
                  if (payload.type === 'attendance_update' && payload.roll === data.student.roll) {
                    document.getElementById('attendance').textContent = payload.attendance + '%';
                  }
                } catch (err) {}
              }
            } catch (e) {
              console.warn('SSE not available', e);
            }          }
        }).catch(err => {
          console.warn('Dashboard fetch failed', err);
        });
    });
  </script>
</body>
</html>
