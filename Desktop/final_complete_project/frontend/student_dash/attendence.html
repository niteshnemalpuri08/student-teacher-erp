<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Records - Student Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

    <style>
        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            margin-bottom: 20px;
            transition: background 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .attendance-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .attendance-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }



        .summary-item {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .summary-item h3 {
            margin: 0 0 10px 0;
            font-size: 2em;
            font-weight: 600;
        }

        .summary-item p {
            margin: 0;
            opacity: 0.8;
        }

        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            overflow: hidden;
        }

        .attendance-table th,
        .attendance-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .attendance-table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: 600;
        }

        .status-present {
            color: #4CAF50;
            font-weight: 600;
        }

        .status-absent {
            color: #f44336;
            font-weight: 600;
        }

        .subjects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .subject-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            transition: transform 0.3s ease;
        }

        .subject-card:hover {
            transform: translateY(-5px);
        }

        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .subject-name {
            font-size: 1.3em;
            font-weight: 600;
        }

        .attendance-badge {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
        }

        .attendance-badge.excellent { background: linear-gradient(135deg, #4CAF50, #45a049); }
        .attendance-badge.good { background: linear-gradient(135deg, #2196F3, #1976D2); }
        .attendance-badge.average { background: linear-gradient(135deg, #FF9800, #F57C00); }
        .attendance-badge.poor { background: linear-gradient(135deg, #f44336, #d32f2f); }

        .subject-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 600;
            display: block;
        }

        .stat-label {
            opacity: 0.8;
            font-size: 0.9em;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            height: 8px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .subject-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="back-btn" onclick="goBack()">‚Üê Back to Dashboard</button>

        <div class="header">
            <h1>üìä Attendance Records</h1>
            <p>Track your attendance history and patterns</p>
        </div>

        <div class="attendance-summary">
            <div class="summary-item">
                <h3 id="totalClasses">0</h3>
                <p>Total Classes</p>
            </div>
            <div class="summary-item">
                <h3 id="presentClasses">0</h3>
                <p>Present Classes</p>
            </div>
            <div class="summary-item">
                <h3 id="absentClasses">0</h3>
                <p>Absent Classes</p>
            </div>
            <div class="summary-item">
                <h3 id="attendancePercent">0%</h3>
                <p>Attendance Rate</p>
            </div>
        </div>

        <div class="subjects-grid" id="subjectsGrid">
            <!-- Subject attendance cards will be populated here -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadAttendanceData();
        });

        // Deterministic hash-based helper to generate consistent pseudo-random values
        function hashToRange(seed, min, max) {
            let h = 2166136261 >>> 0;
            for (let i = 0; i < seed.length; i++) {
                h ^= seed.charCodeAt(i);
                h = Math.imul(h, 16777619) >>> 0;
            }
            return min + (h % (max - min + 1));
        }

        async function loadAttendanceData() {
            // Get user data from localStorage
            const userData = JSON.parse(localStorage.getItem('user') || '{}');

            if (userData.username) {
                try {
                    const response = await fetch(`/api/students/username/${userData.username}`);
                    const studentData = await response.json();

                    if (studentData.attendance !== undefined) {
                        // Use real attendance data
                        const overallAttendance = studentData.attendance;

                        // First try authoritative per-subject rows from /api/subject-attendance/<roll>
                        try {
                            if (studentData.roll) {
                                const saResp = await fetch(`/api/subject-attendance/${studentData.roll}`);
                                if (saResp.ok) {
                                    const saRows = await saResp.json();
                                    if (Array.isArray(saRows) && saRows.length > 0) {
                                        renderFromSubjectData(saRows);
                                        return; // done
                                    }
                                }
                            }
                        } catch (e) {
                            console.warn('Could not fetch subject-attendance rows, falling back:', e);
                        }

                        // Next prefer subject_attendance included in student object
                        if (Array.isArray(studentData.subject_attendance) && studentData.subject_attendance.length > 0) {
                            renderFromSubjectData(studentData.subject_attendance);
                        } else {
                            // Generate subject-wise view from overall attendance if API didn't provide details
                            renderSubjectAttendance(overallAttendance);
                        }
                    }
                } catch (error) {
                    console.error('Error loading student data:', error);
                    // Fallback to mock data
                    loadMockAttendanceData();
                }
            } else {
                // Fallback to mock data
                loadMockAttendanceData();
            }
        }

        function loadMockAttendanceData() {
            // Mock attendance data - 10 classes per subject
            const subjects = ['Mathematics', 'Physics', 'Chemistry', 'Computer Science', 'English'];
            const subjectStats = {};
            const username = (JSON.parse(localStorage.getItem('user') || '{}').username) || 'guest';

            // Deterministic mock generation so values don't change on reload
            subjects.forEach(subject => {
                subjectStats[subject] = { total: 10, present: 0 };
                const variation = hashToRange(username + '|' + subject, -3, 3); // ¬±3%
                const basePercent = 80; // base 80% for mock users
                const percent = Math.max(0, Math.min(100, basePercent + variation));
                subjectStats[subject].present = Math.round((percent / 100) * subjectStats[subject].total);
            });

            const container = document.getElementById('subjectsGrid');
            container.innerHTML = ''; // clear any existing cards
            let totalClasses = 0;
            let totalPresent = 0;

            Object.keys(subjectStats).forEach(subject => {
                const stats = subjectStats[subject];
                const absent = stats.total - stats.present;
                const percent = Math.round((stats.present / stats.total) * 100);

                let attendanceClass = 'excellent';
                if (percent >= 90) attendanceClass = 'excellent';
                else if (percent >= 80) attendanceClass = 'good';
                else if (percent >= 70) attendanceClass = 'average';
                else attendanceClass = 'poor';

                const card = document.createElement('div');
                card.className = 'subject-card';
                card.innerHTML = `
                    <div class="subject-header">
                        <div class="subject-name">${subject}</div>
                        <div class="attendance-badge ${attendanceClass}">${percent}%</div>
                    </div>

                    <div class="subject-stats">
                        <div class="stat-item">
                            <span class="stat-value">${stats.present}</span>
                            <span class="stat-label">Present</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${absent}</span>
                            <span class="stat-label">Absent</span>
                        </div>
                    </div>

                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${percent}%"></div>
                    </div>

                    <div class="subject-details">
                        <div class="detail-item">
                            <span>Total Classes:</span>
                            <span>${stats.total}</span>
                        </div>
                        <div class="detail-item">
                            <span>Attendance Rate:</span>
                            <span>${percent}%</span>
                        </div>
                    </div>
                `;

                container.appendChild(card);

                totalClasses += stats.total;
                totalPresent += stats.present;
            });

            // Update overall summary
            document.getElementById('totalClasses').textContent = totalClasses;
            document.getElementById('presentClasses').textContent = totalPresent;
            document.getElementById('absentClasses').textContent = totalClasses - totalPresent;
            document.getElementById('attendancePercent').textContent = Math.round((totalPresent / totalClasses) * 100) + '%';
        }

        function renderSubjectAttendance(overallAttendance) {
            const subjects = ['Mathematics', 'Physics', 'Chemistry', 'Computer Science', 'English'];
            const container = document.getElementById('subjectsGrid');
            container.innerHTML = ''; // clear existing cards

            // Use consistent attendance data - 10 classes per subject = 50 total classes
            const subjectTotalClasses = 10;
            const totalClasses = subjects.length * subjectTotalClasses;

            // Generate subject-wise attendance with deterministic variations around overall attendance
            const subjectAttendances = [];
            let totalPresentClasses = 0;
            const username = (JSON.parse(localStorage.getItem('user') || '{}').username) || 'guest';

            subjects.forEach(subject => {
                // Deterministic small variation around the overall attendance (¬±3%)
                const variation = hashToRange(username + '|' + subject, -3, 3); // integer percent
                const subjectAttendance = Math.max(0, Math.min(100, overallAttendance + variation));
                const subjectPresent = Math.round((subjectAttendance / 100) * subjectTotalClasses);
                const subjectAbsent = subjectTotalClasses - subjectPresent;

                subjectAttendances.push({
                    name: subject,
                    attendance: subjectAttendance,
                    present: subjectPresent,
                    absent: subjectAbsent
                });

                totalPresentClasses += subjectPresent;
            });

            // Calculate actual overall attendance from subject data
            const actualOverallAttendance = Math.round((totalPresentClasses / totalClasses) * 100);
            const absentClasses = totalClasses - totalPresentClasses;

            // Update overall summary with consistent data
            document.getElementById('totalClasses').textContent = totalClasses;
            document.getElementById('presentClasses').textContent = totalPresentClasses;
            document.getElementById('absentClasses').textContent = absentClasses;
            document.getElementById('attendancePercent').textContent = actualOverallAttendance + '%';

            // Render subject cards with consistent data
            subjectAttendances.forEach(subject => {
                let attendanceClass = 'excellent';
                if (subject.attendance >= 90) attendanceClass = 'excellent';
                else if (subject.attendance >= 80) attendanceClass = 'good';
                else if (subject.attendance >= 70) attendanceClass = 'average';
                else attendanceClass = 'poor';

                const card = document.createElement('div');
                card.className = 'subject-card';
                card.innerHTML = `
                    <div class="subject-header">
                        <div class="subject-name">${subject.name}</div>
                        <div class="attendance-badge ${attendanceClass}">${Math.round(subject.attendance)}%</div>
                    </div>

                    <div class="subject-stats">
                        <div class="stat-item">
                            <span class="stat-value">${subject.present}</span>
                            <span class="stat-label">Present</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${subject.absent}</span>
                            <span class="stat-label">Absent</span>
                        </div>
                    </div>

                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${subject.attendance}%"></div>
                    </div>

                    <div class="subject-details">
                        <div class="detail-item">
                            <span>Total Classes:</span>
                            <span>${subjectTotalClasses}</span>
                        </div>
                        <div class="detail-item">
                            <span>Attendance Rate:</span>
                            <span>${Math.round(subject.attendance)}%</span>
                        </div>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // Render subject data provided by backend as explicit per-subject entries
        function renderFromSubjectData(subjectArray) {
            const container = document.getElementById('subjectsGrid');
            container.innerHTML = ''; // clear existing cards

            const subjectTotalClasses = subjectArray.length ? (subjectArray[0].total || subjectArray[0].total_classes || 10) : 10;
            let totalClasses = 0;
            let totalPresent = 0;

            subjectArray.forEach(subjectRaw => {
                const subjectName = subjectRaw.name || subjectRaw.subject || 'Unknown';
                    const present = subjectRaw.present != null ? subjectRaw.present : (subjectRaw.attended_classes != null ? subjectRaw.attended_classes : 0);
                const total = subjectRaw.total != null ? subjectRaw.total : (subjectRaw.total_classes != null ? subjectRaw.total_classes : subjectTotalClasses);
                const percent = total > 0 ? Math.round((present / total) * 100) : Math.round((subjectRaw.attendance || subjectRaw.attendance_percentage || 0));
                const absent = subjectRaw.absent != null ? subjectRaw.absent : (total - present);

                let attendanceClass = 'excellent';
                if (percent >= 90) attendanceClass = 'excellent';
                else if (percent >= 80) attendanceClass = 'good';
                else if (percent >= 70) attendanceClass = 'average';
                else attendanceClass = 'poor';

                const card = document.createElement('div');
                card.className = 'subject-card';
                card.innerHTML = `
                    <div class="subject-header">
                        <div class="subject-name">${subjectName}</div>
                        <div class="attendance-badge ${attendanceClass}">${percent}%</div>
                    </div>

                    <div class="subject-stats">
                        <div class="stat-item">
                            <span class="stat-value">${present}</span>
                            <span class="stat-label">Present</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${absent}</span>
                            <span class="stat-label">Absent</span>
                        </div>
                    </div>

                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${percent}%"></div>
                    </div>

                    <div class="subject-details">
                        <div class="detail-item">
                            <span>Total Classes:</span>
                            <span>${total}</span>
                        </div>
                        <div class="detail-item">
                            <span>Attendance Rate:</span>
                            <span>${percent}%</span>
                        </div>
                    </div>
                `;

                container.appendChild(card);

                totalClasses += total;
                totalPresent += present;
            });

            document.getElementById('totalClasses').textContent = totalClasses;
            document.getElementById('presentClasses').textContent = totalPresent;
            document.getElementById('absentClasses').textContent = totalClasses - totalPresent;
            document.getElementById('attendancePercent').textContent = Math.round((totalPresent / totalClasses) * 100) + '%';
        }

        function goBack() {
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
