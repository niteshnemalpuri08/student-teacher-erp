<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subject Performance - Student Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

    <style>
        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            margin-bottom: 20px;
            transition: background 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Table-based, structured layout for subjects */
        .subjects-table-container {
            overflow-x: auto;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            padding: 12px;
        }

        .subjects-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 700px;
            background: rgba(255, 255, 255, 0.03);
        }

        .subjects-table thead th {
            text-align: left;
            padding: 12px 16px;
            font-weight: 700;
            font-size: 0.95em;
            color: #e6e6e6;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            background: rgba(255,255,255,0.02);
        }

        .subjects-table tbody td {
            padding: 14px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            vertical-align: middle;
            color: #fff;
        }

        .subject-name-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .grade-badge {
            padding: 6px 12px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.9em;
            display: inline-block;
        }

        .trend-up { color: #4caf50; font-weight:700 }
        .trend-stable { color: #ffb300; font-weight:700 }
        .trend-down { color: #f44336; font-weight:700 }

        @media (max-width: 720px) {
            .subjects-table {
                min-width: 600px;
            }
        }

        .subject-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            transition: transform 0.3s ease;
        }

        .subject-card:hover {
            transform: translateY(-5px);
        }

        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .subject-name {
            font-size: 1.3em;
            font-weight: 600;
        }

        .grade-badge {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
        }

        .grade-badge.excellent { background: linear-gradient(135deg, #4CAF50, #45a049); }
        .grade-badge.good { background: linear-gradient(135deg, #2196F3, #1976D2); }
        .grade-badge.average { background: linear-gradient(135deg, #FF9800, #F57C00); }
        .grade-badge.poor { background: linear-gradient(135deg, #f44336, #d32f2f); }

        .subject-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 600;
            display: block;
        }

        .stat-label {
            opacity: 0.8;
            font-size: 0.9em;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            height: 8px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .subject-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="back-btn" onclick="goBack()">‚Üê Back to Dashboard</button>

        <div class="header">
            <h1>üìö Subject Performance</h1>
            <p>Track your performance across all subjects</p>
        </div>

        <div class="subjects-table-container">
            <table class="subjects-table" id="subjectsTable">
                <thead>
                    <tr>
                        <th>Subject</th>
                        <th>Overall Score</th>
                        <th>Assignments</th>
                        <th>Exams</th>
                        <th>Trend</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Subject rows will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadSubjectData();
        });

        async function loadSubjectData() {
            // Get user data from localStorage
            const userData = JSON.parse(localStorage.getItem('user') || '{}');

            if (userData.username) {
                try {
                    const [studentResponse, assignmentStatsResponse, subjectAttendanceResponse] = await Promise.all([
                        fetch(`/api/students/username/${userData.username}`),
                        fetch(`/api/student/${userData.username}/assignment-stats`, {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            }
                        }),
                        fetch(`/api/subject-attendance/student/${userData.username}`, {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            }
                        })
                    ]);

                    const studentData = await studentResponse.json();
                    const assignmentStats = await assignmentStatsResponse.json();
                    const subjectAttendance = await subjectAttendanceResponse.json();

                    if (studentData.marks) {
                        // Map student marks to subjects
                        const subjectMapping = {
                            'math': 'Mathematics',
                            'physics': 'Physics',
                            'chemistry': 'Chemistry',
                            'cs': 'Computer Science',
                            'english': 'English'
                        };

                        const subjectsData = Object.keys(studentData.marks).map(subjectKey => {
                            const score = studentData.marks[subjectKey];
                            const grade = calculateGrade(score);
                            const subjectName = subjectMapping[subjectKey] || subjectKey;
                            const stats = assignmentStats[subjectName] || {};

                            // Get subject-specific attendance or fallback to overall
                            let subjectAtt = null;
                            if (subjectAttendance) {
                                // Try by subjectName key first (API returns subject name keys)
                                subjectAtt = subjectAttendance[subjectName] || null;
                                if (!subjectAtt && Array.isArray(subjectAttendance)) {
                                    subjectAtt = subjectAttendance.find(s => s.name === subjectName || s.subject === subjectName) || null;
                                }
                            }

                            // Prefer showing present/total when available
                            let present = null;
                            let total = null;
                            let attendancePercent = studentData.attendance || 0;

                            if (subjectAtt) {
                                present = subjectAtt.present != null ? subjectAtt.present : (subjectAtt.attended_classes != null ? subjectAtt.attended_classes : null);
                                total = subjectAtt.total != null ? subjectAtt.total : (subjectAtt.total_classes != null ? subjectAtt.total_classes : null);
                                if (present != null && total != null && total > 0) {
                                    attendancePercent = Math.round((present / total) * 100);
                                } else {
                                    attendancePercent = Math.round(subjectAtt.attendance || subjectAtt.attendance_percentage || attendancePercent);
                                }
                            }

                            return {
                                name: subjectName,
                                grade: grade,
                                score: score,
                                attendance: attendancePercent,
                                present: present,
                                total: total,
                                assignments: Math.round(stats.average_score || score * 0.8), // Use real assignment average or fallback
                                exams: score,
                                trend: score >= 85 ? 'up' : score >= 70 ? 'stable' : 'down'
                            };
                        });

                        renderSubjects(subjectsData);
                    }
                } catch (error) {
                    console.error('Error loading student data:', error);
                    // Fallback to mock data
                    loadMockSubjectData();
                }
            } else {
                // Fallback to mock data
                loadMockSubjectData();
            }
        }

        function loadMockSubjectData() {
            // Mock subject data - fallback
            const subjectsData = [
                {
                    name: 'Mathematics',
                    grade: 'A',
                    score: 92,
                    attendance: 95,
                    assignments: 88,
                    exams: 94,
                    trend: 'up'
                },
                {
                    name: 'Physics',
                    grade: 'B+',
                    score: 87,
                    attendance: 90,
                    assignments: 85,
                    exams: 88,
                    trend: 'up'
                },
                {
                    name: 'Chemistry',
                    grade: 'A-',
                    score: 89,
                    attendance: 92,
                    assignments: 90,
                    exams: 89,
                    trend: 'stable'
                },
                {
                    name: 'Computer Science',
                    grade: 'A',
                    score: 95,
                    attendance: 98,
                    assignments: 92,
                    exams: 96,
                    trend: 'up'
                },
                {
                    name: 'English',
                    grade: 'B',
                    score: 82,
                    attendance: 88,
                    assignments: 80,
                    exams: 83,
                    trend: 'down'
                },
                {
                    name: 'Physical Education',
                    grade: 'A-',
                    score: 91,
                    attendance: 100,
                    assignments: 85,
                    exams: 95,
                    trend: 'up'
                }
            ];

            renderSubjects(subjectsData);
        }

        function renderSubjects(subjectsData) {
            const tbody = document.querySelector('#subjectsTable tbody');
            tbody.innerHTML = '';

            subjectsData.forEach(subject => {
                const tr = document.createElement('tr');

                // Subject name + grade badge
                const nameTd = document.createElement('td');
                nameTd.className = 'subject-name-cell';
                const nameSpan = document.createElement('div');
                nameSpan.textContent = subject.name;
                const badge = document.createElement('span');
                let gradeClass = 'grade-badge excellent';
                if (subject.score >= 90) gradeClass = 'grade-badge excellent';
                else if (subject.score >= 80) gradeClass = 'grade-badge good';
                else if (subject.score >= 70) gradeClass = 'grade-badge average';
                else gradeClass = 'grade-badge poor';
                badge.className = gradeClass;
                badge.textContent = subject.grade;
                nameTd.appendChild(nameSpan);
                nameTd.appendChild(badge);

                // Score
                const scoreTd = document.createElement('td');
                scoreTd.textContent = subject.score + '%';



                // Assignments
                const assignTd = document.createElement('td');
                assignTd.textContent = (subject.assignments != null ? subject.assignments + '%' : '-');

                // Exams
                const examsTd = document.createElement('td');
                examsTd.textContent = (subject.exams != null ? subject.exams + '%' : '-');

                // Trend with color
                const trendTd = document.createElement('td');
                let trendText = '‚û°Ô∏è Stable';
                let trendClass = 'trend-stable';
                if (subject.trend === 'up') { trendText = '‚ÜóÔ∏è Improving'; trendClass = 'trend-up'; }
                else if (subject.trend === 'down') { trendText = '‚ÜòÔ∏è Declining'; trendClass = 'trend-down'; }
                trendTd.textContent = trendText;
                trendTd.className = trendClass;

                tr.appendChild(nameTd);
                tr.appendChild(scoreTd);
                tr.appendChild(assignTd);
                tr.appendChild(examsTd);
                tr.appendChild(trendTd);

                tbody.appendChild(tr);
            });
        }

        function calculateGrade(score) {
            if (score >= 90) return 'A';
            if (score >= 80) return 'B';
            if (score >= 70) return 'C';
            if (score >= 60) return 'D';
            return 'F';
        }

        function goBack() {
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
